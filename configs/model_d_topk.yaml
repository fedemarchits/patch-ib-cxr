experiment_name: "model_d_topk"

data:
  json_path: "/workspace/mimic_master_official_split.jsonl"
  image_root: "/datasets/MIMIC-CXR/files"
  batch_size: 64
  num_workers: 4
  image_size: 224

model:
  vision_backbone: "hf-hub:microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224"
  text_backbone: "hf-hub:microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224"
  temperature: 0.1

  # Contrastive loss weights
  contrastive_mask_weight: 1.0   # Weight for L_NCE-mask (on masked embedding)
  contrastive_full_weight: 1.0   # Weight for L_NCE-full (on full embedding)

  # ============ MODEL D: TOP-K PATCH SELECTION ============
  # Enable masking with Top-K selection (instead of threshold)
  use_masking: true
  use_topk_masking: true  # Key difference from Model C

  # Top-K ratio: fraction of patches to keep
  # 0.25 = keep 25% = 49 patches out of 196
  # Lower = more compression, higher efficiency
  k_ratio: 0.25

  # Sparsity loss (helps learn meaningful importance scores)
  use_sparsity_loss: true
  sparsity_weight: 5.0  # Lower than Model C since sparsity is guaranteed

  # Consistency loss (keep masked embedding close to full embedding)
  consistency_weight: 1.0
  consistency_include_negatives: false

  # ============ LOCAL ALIGNMENT CONFIGURATION ============
  # Local alignment uses ONLY Top-K patches (more efficient)
  use_local_alignment: true
  local_alignment_temperature: 0.7
  use_uncertainty_weighting: false
  local_alignment_weight: 100
  local_alignment_warmup_steps: 500
  local_alignment_n_heads: 4
  local_alignment_dropout: 0.1

training:
  # Early stopping on combined metric
  early_stopping_metric: "combined"

  combined_weights:
    recall: 0.7
    auc: 0.3

  eval_auc_every: 1

  epochs: 40
  lr: 5.0e-6
  weight_decay: 0.01
  warmup_steps: 1000
  early_stopping_patience: 7
  print_freq: 50
  device: "cuda"
  use_amp: true
  gradient_accumulation_steps: 2

  # Fine-tuning options
  freeze_backbone: false
  llrd_factor: 0.85

wandb:
  enable: true
  project: "Thesis-PatchIB"
  run_name: "model-d-topk-k25"
